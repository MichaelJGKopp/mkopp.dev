name: mysite_swarm_dev

# This compose file is for LOCAL DEVELOPMENT using Docker Swarm.
# It builds images locally and enables replicas and rolling updates.

services:
  reverse-proxy:
    image: traefik:v3.5
    command:
      - "--log.level=DEBUG"
      - "--api.dashboard=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--providers.docker.network=web"
    ports:
      - "80:80"
      - "443:443"
    networks:
      - web
      - backend
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    deploy:
      placement:
        constraints:
          - "node.role == manager"
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api.rule=Host(`traefik.localhost`)"
        - "traefik.http.routers.api.entrypoints=web"
        - "traefik.http.routers.api.service=api@internal"

  postgres:
    image: postgres:16.10-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5555:5432"
    networks:
      - database
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      replicas: 1

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.4
    command: start-dev
    volumes:
      - ./keycloak-realm-config/mkopp-dev-realm.json:/opt/keycloak/data/import/mkopp-realm.json
    environment:
      - KC_DB=postgres
      - KC_DB_URL_HOST=postgres
      - KC_DB_URL_DATABASE=${POSTGRES_DB}
      - KC_DB_USERNAME=${POSTGRES_USER}
      - KC_DB_PASSWORD=${POSTGRES_PASSWORD}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_HTTP_ENABLED=true
      - KC_HTTP_PORT=8080
    networks:
      - database
      - web
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.keycloak.rule=${KEYCLOAK_HTTP_RULE}"
        - "traefik.http.routers.keycloak.entrypoints=web"
        - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
        - "traefik.docker.network=web"

  backend:
    build:
      context: ..
      dockerfile: apps/mysite-backend/Dockerfile
    image: mysite-backend-dev:latest # Give the built image a name
    environment:
      SPRING_PROFILES_ACTIVE: "dev"
      CONTROLLER_LOGGING_ASPECT_LEVEL: "${CONTROLLER_LOGGING_ASPECT_LEVEL}"
      SERVICE_LOGGING_ASPECT_LEVEL: "${SERVICE_LOGGING_ASPECT_LEVEL}"
      CONTROLLER_LOGGING_REQUEST_ARGS: "${CONTROLLER_LOGGING_REQUEST_ARGS}"
      SERVICE_LOGGING_REQUEST_ARGS: "${SERVICE_LOGGING_REQUEST_ARGS}"
    networks:
      - backend
      - database
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/management/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=backend"
        - "traefik.http.services.backend-svc.loadbalancer.server.port=8200"
        - "traefik.http.routers.backend-public.rule=${TRAEFIK_HTTP_BACKEND_RULE}"
        - "traefik.http.routers.backend-public.entrypoints=web"
        - "traefik.http.routers.backend-public.service=backend-svc"

  frontend:
    build:
      context: ..
      dockerfile: apps/mysite-frontend/Dockerfile.dev # Use the dev dockerfile
    image: mysite-frontend-dev:latest # Give the built image a name
    networks:
      - web
      - backend
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/healthz', (res) => process.exit(res.statusCode == 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend.rule=${TRAEFIK_HTTP_RULE}"
        - "traefik.http.services.frontend.loadbalancer.server.port=4000"
        - "traefik.docker.network=web"
        - "traefik.http.routers.frontend.entrypoints=web"

networks:
  web:
    driver: overlay
  backend:
    driver: overlay
  database:
    driver: overlay

volumes:
  db-data:
